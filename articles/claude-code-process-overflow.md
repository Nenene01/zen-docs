---
title: "Claude Codeのプロセス増殖でMacがフリーズした話"
emoji: "🧊"
type: "tech"
topics: ["claudecode", "ai", "mac", "トラブルシューティング"]
published: true
---

## 何が起きたか

連日、Claude Code（AIエージェント）を使って筋トレ記録アプリ「MuscleLog」の開発を進めていました。プロジェクト用にサブエージェントやルール、スキルを整備し、効率的な開発フローを構築していたつもりでした。

ところが昨日から、Macがやたらとフリーズするようになりました。

- CLIでの入力がカクカクする
- 日本語変換が遅延する
- アプリの切り替えがもたつく

「まさか...」と思いアクティビティモニタを確認すると、**claudeと名前のついたプロセスが大量に発生**していました。

## 発見時の状況

アクティビティモニタで確認したところ、複数の`claude`プロセスが同時に実行されていました。

```
USER     %CPU  %MEM   PID COMMAND
hoge     15.2   1.8  1234 claude
hoge     12.8   1.6  1235 claude
hoge     11.5   1.5  1236 claude
hoge     10.2   1.4  1237 claude
hoge      8.9   1.3  1238 claude
hoge      7.5   1.2  1239 claude
...
```

各プロセスが約130MBのメモリを消費しており、大量にメモリを爆食してました。

## 原因の推測

振り返ってみると、心当たりがありました。

1. **サブエージェントの頻繁な呼び出し**
   - Biomeのlint/type-checkを行う`biome-checker`サブエージェントを設定していた
   - このエージェントは「コード変更後にプロアクティブに使用」と設定していた

2. **並列実行の多用**
   - JSDoc生成エージェントは複数ファイルを並列で処理する設計だった

3. **プロセスが正常終了していない可能性**
   - ターミナルを閉じてもバックグラウンドで残存
   - サブエージェントのプロセスが適切にクリーンアップされていない

## 暫定対応

### 1. 残存プロセスの確認

```bash
ps aux | grep -i claude | grep -v grep
```

### 2. すべてのClaudeプロセスを強制終了

```bash
pkill -9 -f claude
```

これでメモリが一気に解放されました。

### 3. 正しい終了方法の再確認

Claude Codeセッションを終了する際は：

- `/exit` コマンドを使用する
- `Ctrl+C` を2回押す
- **ターミナルを閉じる前に必ずセッションを終了する**

### 4. 確認用エイリアスの設定

`.zshrc`や`.bashrc`に追加しておくと便利：

```bash
# Claudeプロセスの確認
alias claude-ps='ps aux | grep -i claude | grep -v grep'

# Claudeプロセスの強制終了
alias claude-kill='pkill -f claude'
```

## 再発防止のために

### 開発セッション後の習慣

- セッション終了時は必ず`/exit`を実行
- 長時間作業後は`claude-ps`でプロセス確認
- 不要なプロセスがあれば`claude-kill`で終了

### サブエージェント設定の見直し

この後、サブエージェントの設定を見直しました。詳細は別記事で書く予定ですが、要点は：

- 「プロアクティブに使用」という自動呼び出しを控える
- 並列実行の上限を設ける
- 明示的な呼び出しを推奨する設計にする

## まとめ

Claude Codeは非常に強力なツールですが、サブエージェントを多用するとプロセスが増殖する可能性があります。

**教訓：**
- 定期的にプロセスの状態を確認する
- セッションは正しく終了する
- サブエージェントの自動呼び出しは慎重に設定する

AIエージェントを活用した開発は生産性が上がる反面、リソース管理には注意が必要ですね。
