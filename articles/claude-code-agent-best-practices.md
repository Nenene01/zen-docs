---
title: "Claude Codeサブエージェントでメモリリークを防ぐ設計パターン"
emoji: "🔧"
type: "tech"
topics: ["claudecode", "ai", "開発効率化", "設計パターン"]
published: true
---

## はじめに

前回の記事で、Claude Codeのプロセスが増殖してMacがフリーズした経験を書きました。

https://zenn.dev/nenene01/articles/claude-code-process-overflow

今回は、実際に問題を引き起こしていたサブエージェントの設定を分析し、改善パターンを紹介します。

## 問題のあった設定

### 1. プロアクティブな自動呼び出し

私のプロジェクトでは、Biomeによるlint/formatチェックを行うサブエージェントを設定していました。

```markdown:biome-checker.md
---
name: biome-checker
description: Biome lint・フォーマッターの実行エージェント。コード変更後に自動的に使用し、コード品質を保証します。コードの修正や追加後にはプロアクティブに使用してください。
tools: Bash, Read, Glob
model: haiku
---
```

**問題点：**
- `description`に「**プロアクティブに使用してください**」と記載
- Claude Codeがこれを解釈し、コード変更のたびに自動的にサブエージェントを起動
- 頻繁なコード編集 → 大量のサブエージェント起動 → プロセス増殖

### 2. 無制限の並列実行

JSDoc生成用のサブエージェントでは、並列実行を推奨していました。

```markdown:README.md
#### 並列実行

複数ファイルがある場合、`/jsdoc` スキルは複数のjsdoc-generatorエージェントを**並列で起動**します。
```

**問題点：**
- 対象ファイルが多いと、一度に大量のプロセスが生成される
- 10ファイルあれば10プロセスが同時に起動
- 各プロセスが約130MB消費 → 1.3GBのメモリ消費

## 改善パターン

### パターン1: 明示的な呼び出しのみにする

**Before（問題あり）:**
```markdown
description: ...コードの修正や追加後にはプロアクティブに使用してください。
```

**After（改善後）:**
```markdown
description: Biome lint・フォーマッターの実行エージェント。明示的な指示があった場合のみ使用します。
```

「プロアクティブに使用」という表現を削除し、明示的な呼び出しのみに変更します。

### パターン2: 呼び出し条件を限定する

**Before:**
```markdown
description: コード変更後に自動的に使用し、コード品質を保証します。
```

**After:**
```markdown
description: PRの作成前やコミット前のコード品質チェックに使用します。日常的なコード編集中は呼び出しません。
```

「いつ使うか」を具体的に限定することで、不要な呼び出しを防ぎます。

### パターン3: 並列実行の制限

**Before:**
```markdown
複数ファイルがある場合、並列で起動します。
```

**After:**
```markdown
複数ファイルがある場合でも、順次処理を行います。
または、最大3ファイルまで並列処理し、残りは順次処理します。
```

並列実行を制限するか、上限を設けます。

### パターン4: 軽量な代替手段を用意する

サブエージェントを起動する代わりに、直接コマンドを実行する方法を提供します。

```markdown
## 使い分け

### 軽量チェック（推奨）
単純なlint/formatチェックは、サブエージェントを使わずに直接実行：
- `npm run check` - lint + format チェック
- `npm run check:fix` - 自動修正

### サブエージェント使用
以下の場合のみサブエージェントを使用：
- 複雑な分析が必要な場合
- 修正方針の判断が必要な場合
- レポートが必要な場合
```

## 推奨する設定構成

### サブエージェント定義のテンプレート

```markdown
---
name: my-agent
description: [具体的な用途]。明示的な指示があった場合のみ使用します。
tools: [必要最小限のツール]
model: haiku
---

# [エージェント名]

## 使用タイミング

**使用する場合：**
- PRの作成前
- コミット前の最終確認
- 明示的に指示された場合

**使用しない場合：**
- 通常のコード編集中
- 小さな修正の都度
- 自動的・プロアクティブな呼び出し

## 実行手順

1. [手順1]
2. [手順2]
3. [手順3]

## 注意事項

- 並列実行は最大3プロセスまで
- 処理完了後は明示的に終了を報告
```

### settings.jsonでの制御

```json
{
  "rules": [
    {
      "path": ".claude/rules/agent-guidelines.md",
      "globs": ["**/*"]
    }
  ]
}
```

共通ルールファイルで、エージェント呼び出しのガイドラインを定義します。

```markdown:agent-guidelines.md
# サブエージェント使用ガイドライン

## 基本方針

1. サブエージェントは明示的な指示があった場合のみ使用
2. 日常的なコード編集中は直接コマンドを優先
3. 並列実行は控えめに（最大3プロセス）
4. 処理完了後は速やかに終了

## 禁止事項

- 「プロアクティブに使用」という自動呼び出し
- 無制限の並列実行
- 終了条件のない継続的な監視
```

## プロセス管理のベストプラクティス

### 1. 定期的な確認

開発セッション中は定期的にプロセスを確認：

```bash
# エイリアスを設定
alias claude-ps='ps aux | grep -i claude | grep -v grep'
```

### 2. セッション終了時のクリーンアップ

```bash
# 終了前に確認
claude-ps

# 不要なプロセスがあれば終了
pkill -f claude
```

### 3. 長時間セッションの中断

1時間以上の開発セッション後は、一度Claude Codeを終了して再起動することを推奨します。

## まとめ

| 項目 | 問題のある設定 | 改善後の設定 |
|------|--------------|------------|
| 呼び出し | プロアクティブ | 明示的のみ |
| 並列実行 | 無制限 | 最大3プロセス |
| 用途 | 全般的 | 限定的（PR前など） |
| 代替手段 | なし | 直接コマンドを推奨 |

Claude Codeのサブエージェントは強力ですが、設定次第でリソースを大量消費する可能性があります。

**教訓：**
- 「プロアクティブ」は危険なキーワード
- 並列実行には必ず上限を設ける
- シンプルなタスクは直接コマンドで

適切な設計で、快適なAIエージェント開発を楽しみましょう。
